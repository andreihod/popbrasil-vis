<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>População Brasileira</title>

	<script src="popBrasil.json"></script>

	<link rel="stylesheet" href="style.css">

</head>
<body onload="draw()">
	
	<label id="anos-text">2008 </label> <input type="range" min="2001" max="2017" value="2008" class="slider" id="anos-range" onchange="mostraAnos()"> 

	<br>

	<canvas id="canvas" width="1080" height="540">
		

	</canvas>

	<script>

		const PRIMEIRO_ANO = 2001;
		const ULTIMO_ANO = 2017;
		const TAMANHO_BARRA = 445;
		const TAMANHO_BARRA_POP = 45000000; // 40 milhões é o tamanho máximo da barra em população
		const QTD_ESTADOS = 26;
		const COLORS = ['Blue', 'BlueViolet', 'Brown', 'CadetBlue', 'Chartreuse', 'Chocolate', 'CornflowerBlue', 'Crimson', 'DarkGreen', 'DarkMagenta',
						'DarkRed', 'DeepPink', 'FireBrick', 'Indigo', 'LawnGreen', 'LightSeaGreen', 'MediumOrchid', 'Olive', 'Red', 'SteelBlue',
						'Tomato', 'Yellow', 'Sienna', 'RoyalBlue', 'Plum', 'LimeGreen'];
		var dataset = {};

		indexaCidades();

		var ano_selecionado = 2008;
		var rects = [] // Barras desenhadas para fazer o mouseover
		var isDrawing = false;

		var canvas = document.getElementById("canvas");
		var ctx = canvas.getContext("2d");

		function draw() {

			isDrawing = true;

			ctx.restore();
			ctx.save();

			ctx.clearRect(0, 0, canvas.width, canvas.height);

			var height, width, widthOffset, heightOffset;
			width = canvas.width;
			height = canvas.height;
			widthOffset = width/2;
			heightOffset = 20;

			ctx.strokeStyle = "#000";
			ctx.font = "bold 18px Arial";
			
			// Eixo y
			ctx.moveTo(110, 5);
			ctx.lineTo(110, 450);
			ctx.stroke();

			// Eixo x
			ctx.moveTo(110, 450);
   			ctx.lineTo(1040, 450);
   			ctx.stroke();

   			// Labels
			ctx.fillText("Estados", widthOffset, height - heightOffset);
			ctx.fillText("População", 8, height/2 - heightOffset);
			ctx.font = "normal 12px Arial";
			ctx.fillText("(em milhões)", 8, height/2 - heightOffset + 20);

			
			ctx.strokeStyle = "#999";
			ctx.font = "bold 14px Arial";

			// Desenha gráfico de estados do ano selecionado									
			var estados = dataset[ano_selecionado].estados;
			var barOffset = 14; // Espaçamento das barras
			var barWidth = (930 - barOffset * (QTD_ESTADOS + 1)) / QTD_ESTADOS - 1; // Calcula a largura da barra necessária
			var xPos = 110 + barOffset;
			var i = 0;
			rects = [];
			for (var label in estados){

			    estado = estados[label];

			    var size = (estado.populacao * TAMANHO_BARRA) / TAMANHO_BARRA_POP; // Calcula tamanho da barra em relação a população
			    var yPos = 450 - size - 1;
			    ctx.fillStyle = COLORS[i % QTD_ESTADOS]; // Escolhe a cor
			    ctx.fillRect(xPos, yPos, barWidth, size); // Desenha a barra
			    rects.push({x: xPos, y:yPos, w: barWidth, h: size});

			    ctx.fillStyle = '#333'
				ctx.font = "14px Arial";
			    ctx.fillText(label, xPos, 465); // Label do estado no eixo X

			    // Alinha a população no centro exato da barra
			    var txt = parseFloat(estado.populacao/1000000).toFixed(2);
			    var offsetTxt = (ctx.measureText(txt).width - barWidth) / 2;
			    ctx.fillText(txt, xPos - offsetTxt, yPos- 5); // População em cima da barra

			    xPos += barOffset + barWidth;
			    i++;
			}

			isDrawing = false;

		}

		function mostraAnos () {
			ano_selecionado = parseInt(document.getElementById("anos-range").value);
			document.getElementById("anos-text").innerHTML = ano_selecionado;
			draw();
		}

		function indexaCidades() {
			// Organiza os dados em um novo dataset
			
			for (var i = PRIMEIRO_ANO; i <= ULTIMO_ANO; i++) {
				dataset[i] = {'estados': {}};				
			}
			
			for (i in popbrasil) {

				var cidade = popbrasil[i];
				var nome = cidade['Cidade']; // Nome da cidade
				var estado = nome.match(/\(.+\)/)[0].substr(1,2); // Pega o estado e retira os "( )"

				for (var j = PRIMEIRO_ANO; j <= ULTIMO_ANO; j++) {
					if(!dataset[j].estados[estado]){ // Se ano ainda não tem o estado, cria
						dataset[j].estados[estado] = {'cidades': [], 'populacao': 0};
					}
					var populacao = Number.isInteger(cidade[j]) ? cidade[j] : 0; // Algumas populações estão zeradas
					dataset[j].estados[estado].populacao += populacao; // Soma a população estado naquele ano
					dataset[j].estados[estado].cidades.push({'nome': nome, 'populacao': populacao}); // registra a cidade
				}
			}

			console.log(dataset);
		}

		canvas.onmousemove = function(e) {

			if (isDrawing)
				return;

		  	// Pega a posição do mouse
		  	var rect = this.getBoundingClientRect(),
		    x = e.clientX - rect.left,
		    y = e.clientY - rect.top,
		    i = 0, r;

		    canvas.style.cursor = "default";

		    draw();
		   
			while(r = rects[i++]) {

				// add a single rect to path:
			    ctx.beginPath();
			    ctx.rect(r.x, r.y, r.w, r.h); 

				if (ctx.isPointInPath(x, y)) { // Se está em cima da barra

					canvas.style.cursor = "pointer";				    
				    ctx.strokeStyle = "black";
				    ctx.lineWidth = 3;
				    ctx.strokeRect(r.x, r.y, r.w, r.h);
				} 

			  	ctx.closePath();
			    
			 }
		};

	</script>
	
</body>
</html>